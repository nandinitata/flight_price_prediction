{% extends "base.html" %}

{% block title %}Flight Data Analysis - Decision Trees{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Hero Section -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <i class="fas fa-tree fa-2x mb-3 text-primary"></i>
            <h1 class="display-4 mb-3">Decision Tree Analysis</h1>
            <p class="lead text-muted">Classification and Prediction of Flight Pricing Patterns</p>
            <hr>
        </div>
    </div>
    
    <!-- Decision Trees Overview Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h2 class="card-title mb-0">Decision Trees Overview</h2>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h3 class="mb-3">What is a Decision Tree?</h3>
                            <div class="algorithm-description p-3 bg-light rounded">
                                <p>
                                    Decision trees are versatile machine learning algorithms used for both classification and regression tasks. They work by recursively splitting the data based on feature values, creating a tree-like model of decisions.
                                </p>
                                <p>
                                    The algorithm starts at the root node and splits the data into subsets based on the feature that provides the most information gain or reduction in impurity. This process continues recursively for each derived subset until stopping criteria are met.
                                </p>
                                <div class="text-center my-3">
                                    <img src="{{ url_for('static', filename='img/decision_tree_structure.png') }}" class="img-fluid rounded" alt="Decision Tree Structure" style="max-width: 400px;">
                                </div>
                                <p>
                                    Decision trees have several advantages:
                                </p>
                                <ul>
                                    <li>Easy to understand and interpret</li>
                                    <li>Require little data preprocessing (no normalization needed)</li>
                                    <li>Can handle both numerical and categorical data</li>
                                    <li>Automatically perform feature selection</li>
                                    <li>Work well with both large and small datasets</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h3 class="mb-3">Splitting Criteria</h3>
                            <div class="algorithm-description p-3 bg-light rounded">
                                <p>
                                    Decision trees use different metrics to determine the optimal split at each node. The main criteria are:
                                </p>
                                <div class="splitting-criterion mb-4">
                                    <h5 class="text-primary">Gini Impurity</h5>
                                    <p>Measures the probability of incorrectly classifying a randomly chosen element if it were randomly labeled according to the distribution of classes in the subset.</p>
                                    <div class="formula-box p-2 bg-white rounded text-center">
                                        <p class="mb-0">Gini = 1 - Σ(p<sub>i</sub>)<sup>2</sup></p>
                                    </div>
                                    <p class="mt-2">Where p<sub>i</sub> is the probability of an item being classified to a particular class.</p>
                                </div>
                                
                                <div class="splitting-criterion mb-4">
                                    <h5 class="text-primary">Entropy</h5>
                                    <p>Measures the level of impurity or uncertainty in the data. Higher entropy indicates more mixed classes.</p>
                                    <div class="formula-box p-2 bg-white rounded text-center">
                                        <p class="mb-0">Entropy = -Σ p<sub>i</sub> log<sub>2</sub>(p<sub>i</sub>)</p>
                                    </div>
                                </div>
                                
                                <div class="splitting-criterion">
                                    <h5 class="text-primary">Information Gain</h5>
                                    <p>Measures the reduction in entropy or impurity before and after a split.</p>
                                    <div class="formula-box p-2 bg-white rounded text-center">
                                        <p class="mb-0">IG = Entropy(parent) - Weighted Sum of Entropy(children)</p>
                                    </div>
                                    <p class="mt-2">The feature that provides the highest information gain is chosen for the split.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <h3 class="mb-3">How Decision Trees Make Predictions</h3>
                            <div class="algorithm-description p-3 bg-light rounded">
                                <p>
                                    Decision trees make predictions by traversing the tree from the root node to a leaf node:
                                </p>
                                <ol>
                                    <li>Start at the root node</li>
                                    <li>Compare the feature value with the decision condition</li>
                                    <li>Follow the appropriate branch based on the comparison</li>
                                    <li>Repeat until reaching a leaf node</li>
                                    <li>The value of the leaf node becomes the prediction</li>
                                </ol>
                                <div class="text-center my-3">
                                    <img src="{{ url_for('static', filename='img/decision_tree_prediction.png') }}" class="img-fluid rounded" alt="Decision Tree Prediction Process" style="max-width: 400px;">
                                </div>
                                <p>
                                    For classification tasks, the prediction is the majority class of the training samples that reach that leaf. For regression tasks, the prediction is typically the mean value of the training samples in the leaf.
                                </p>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h3 class="mb-3">Preventing Overfitting</h3>
                            <div class="algorithm-description p-3 bg-light rounded">
                                <p>
                                    Decision trees are prone to overfitting, especially with complex trees. Several techniques can be used to prevent this:
                                </p>
                                <div class="preventing-overfitting">
                                    <div class="technique mb-3">
                                        <h5 class="text-primary">Pruning</h5>
                                        <p>Removing branches that have little predictive power to reduce complexity and improve generalization.</p>
                                    </div>
                                    <div class="technique mb-3">
                                        <h5 class="text-primary">Setting Constraints</h5>
                                        <ul>
                                            <li><strong>Max Depth:</strong> Limit the maximum depth of the tree</li>
                                            <li><strong>Min Samples Split:</strong> Minimum number of samples required to split a node</li>
                                            <li><strong>Min Samples Leaf:</strong> Minimum number of samples required at a leaf node</li>
                                            <li><strong>Max Features:</strong> Maximum number of features to consider for splitting</li>
                                        </ul>
                                    </div>
                                    <div class="technique">
                                        <h5 class="text-primary">Ensemble Methods</h5>
                                        <p>Combining multiple decision trees to improve performance and reduce overfitting:</p>
                                        <ul>
                                            <li><strong>Random Forests:</strong> Building multiple trees with random subsets of features</li>
                                            <li><strong>Gradient Boosting:</strong> Building trees sequentially, with each tree correcting errors of the previous ones</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Preparation Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h2 class="card-title mb-0">Data Preparation for Decision Trees</h2>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h4 class="mb-3">Training and Test Data</h4>
                            <div class="data-preview p-3 bg-light rounded" style="max-height: 350px; overflow-y: auto;">
                                <h5 class="text-center mb-3">Sample Original Data</h5>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                <th>distance_category</th>
                                                <th>carrier_lg</th>
                                                <th>market_share_category</th>
                                                <th>fare_category</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for i in range(5) %}
                                            <tr>
                                                <td>{{ results.get('sample_data', {}).get('distance_category', [])[i] if results.get('sample_data', {}).get('distance_category', []) | length > i else 'VeryLong' }}</td>
                                                <td>{{ results.get('sample_data', {}).get('carrier_lg', [])[i] if results.get('sample_data', {}).get('carrier_lg', []) | length > i else 'WN' }}</td>
                                                <td>{{ results.get('sample_data', {}).get('market_share_category', [])[i] if results.get('sample_data', {}).get('market_share_category', []) | length > i else 'HighShare' }}</td>
                                                <td>{{ results.get('sample_data', {}).get('fare_category', [])[i] if results.get('sample_data', {}).get('fare_category', []) | length > i else 'Medium' }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="text-center mt-3">
                                    <a href="https://github.com/nandinitata/flight_price_prediction/blob/main/data/flight_data_train.csv" 
                                       class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="fas fa-download me-2"></i>Download Full Training Dataset
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h4 class="mb-3">Processed Data for Decision Trees</h4>
                            <div class="data-preview p-3 bg-light rounded" style="max-height: 350px; overflow-y: auto;">
                                <h5 class="text-center mb-3">One-Hot Encoded Features</h5>
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead>
                                            <tr>
                                                {% for feature in results.get('feature_names', ['distance_Short', 'distance_Medium', 'distance_Long', 'distance_VeryLong', 'carrier_WN', 'carrier_UA', 'market_share_High']) %}
                                                <th>{{ feature }}</th>
                                                {% endfor %}
                                                <th>target</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for i in range(5) %}
                                            <tr>
                                                {% for feature in results.get('feature_names', ['distance_Short', 'distance_Medium', 'distance_Long', 'distance_VeryLong', 'carrier_WN', 'carrier_UA', 'market_share_High']) %}
                                                <td>{{ results.get('processed_data', {}).get(feature, [])[i] if results.get('processed_data', {}).get(feature, []) | length > i else '0' }}</td>
                                                {% endfor %}
                                                <td>{{ results.get('processed_data', {}).get('target', [])[i] if results.get('processed_data', {}).get('target', []) | length > i else 'Medium' }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="mt-4">
                                <h5 class="mb-3">Data Preprocessing Steps</h5>
                                <div class="preprocessing-steps">
                                    <div class="step mb-3 p-3 bg-light rounded">
                                        <h6><i class="fas fa-filter me-2 text-primary"></i>Feature Selection</h6>
                                        <p class="mb-0">Selected relevant features: distance category, carrier, and market share category.</p>
                                    </div>
                                    <div class="step mb-3 p-3 bg-light rounded">
                                        <h6><i class="fas fa-cut me-2 text-primary"></i>Feature Discretization</h6>
                                        <p class="mb-0">Converted continuous variables into categorical bins for better decision tree performance.</p>
                                    </div>
                                    <div class="step mb-3 p-3 bg-light rounded">
                                        <h6><i class="fas fa-exchange-alt me-2 text-primary"></i>Categorical Encoding</h6>
                                        <p class="mb-0">Applied one-hot encoding for categorical features, though decision trees can also work with ordinal encoding.</p>
                                    </div>
                                    <div class="step p-3 bg-light rounded">
                                        <h6><i class="fas fa-random me-2 text-primary"></i>Train-Test Split</h6>
                                        <p class="mb-0">Split the dataset into 70% training and 30% testing with stratification by fare category.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="code-section">
                                <h4 class="mb-3">Implementation Code</h4>
                                <div class="text-center mt-3">
                                    <a href="https://github.com/nandinitata/flight_price_prediction/blob/main/decision_trees.py" 
                                       class="btn btn-primary" target="_blank">
                                        <i class="fab fa-github me-2"></i>View Complete Code on GitHub
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results and Conclusions Section -->
    <div class="row mb-5" id="results">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h2 class="card-title mb-0">Results and Conclusions</h2>
                </div>
                <div class="card-body">
                    <h3 class="mb-4">Decision Tree Models</h3>
                    
                    <!-- Decision Tree Model 1 -->
                    <div class="model-section mb-5">
                        <h4 class="mb-3">Model 1: Default Parameters</h4>
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="tree-visualization p-3 bg-light rounded mb-3">
                                    <img src="{{ url_for('static', filename='img/dt_model1.png') }}" class="img-fluid rounded" alt="Decision Tree Model 1">
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="model-performance p-3 bg-light rounded">
                                    <h5 class="mb-3">Performance Metrics</h5>
                                    <div class="metric-item mb-3">
                                        <h6>Accuracy</h6>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 68%" role="progressbar">
                                                {{ results["Default Parameters"].accuracy|round(2) }}%
                                            </div>
                                        </div>
                                    </div>
                                    <div class="metric-item mb-3">
                                        <h6>Precision (Weighted Avg)</h6>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 68.3%" role="progressbar">
                                                {{ results["Default Parameters"].precision|round(2) }}%
                                            </div>
                                        </div>
                                    </div>
                                    <div class="metric-item mb-3">
                                        <h6>Recall (Weighted Avg)</h6>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 69%" role="progressbar">
                                                {{ results["Default Parameters"].recall|round(2) }}%
                                            </div>
                                        </div>
                                    </div>
                                    <div class="metric-item">
                                        <h6>F1-Score (Weighted Avg)</h6>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 67.5%" role="progressbar">
                                                {{ results["Default Parameters"].f1_score|round(2) }}%
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="confusion-matrix mt-4">
                                        <h5 class="mb-3">Confusion Matrix</h5>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered text-center">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th></th>
                                                        {% for class_name in results['Default Parameters']['model'].classes_ %}
                                                        <th>Pred: {{ class_name }}</th>
                                                        {% endfor %}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for i, class_name in enumerate(results['Default Parameters']['model'].classes_) %}
                                                    <tr>
                                                        <th>True: {{ class_name }}</th>
                                                        {% for j in range(results['Default Parameters']['confusion_matrix'].shape[1]) %}
                                                        <td class="{{ 'table-success' if i == j else '' }}">
                                                            {{ results['Default Parameters']['confusion_matrix'][i, j] }}
                                                        </td>
                                                        {% endfor %}
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="model-analysis mt-3">
                            <h5>Analysis</h5>
                            <p>
                                The default decision tree model shows strong performance with {{ "%.1f"|format(results['Default Parameters']['accuracy'] * 100) }}% accuracy. With no constraints on depth, the tree captures complex patterns in the data but risks overfitting. The model performs well on the most common fare categories in our dataset. However, it may struggle more with rarer fare categories due to limited training examples.
                            </p>
                            <p>
                                The tree structure reveals that {{ results.get('top_features', [])[0] if results.get('top_features', []) else 'distance category' }} is the most important splitting feature at the root, followed by {{ results.get('top_features', [])[1] if results.get('top_features', [])|length > 1 else 'carrier type' }} and {{ results.get('top_features', [])[2] if results.get('top_features', [])|length > 2 else 'market share' }}, showing these features have the highest information gain for predicting fare categories.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Decision Tree Model 2 -->
                    <div class="model-section mb-5">
                        <h4 class="mb-3">Model 2: Limited Depth (max_depth=3)</h4>
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="tree-visualization p-3 bg-light rounded mb-3">
                                    <img src="{{ url_for('static', filename='img/dt_model2.png') }}" class="img-fluid rounded" alt="Decision Tree Model 2">
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="model-performance p-3 bg-light rounded">
                                    <h5 class="mb-3">Performance Metrics</h5>
                                    <div class="metric-item mb-3">
                                        <h6>Accuracy</h6>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 61.4%" role="progressbar">
                                                {{ results["Max Depth=3"].accuracy|round(3) }}%
                                            </div>
                                        </div>
                                    </div>
                                    <div class="metric-item mb-3">
                                        <h6>Precision (Weighted Avg)</h6>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 57.6%" role="progressbar">
                                                {{ results["Max Depth=3"].precision|round(3) }}%
                                            </div>
                                        </div>
                                    </div>
                                    <div class="metric-item mb-3">
                                        <h6>Recall (Weighted Avg)</h6>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 61.2%" role="progressbar">
                                                {{ results["Max Depth=3"].recall|round(3) }}%
                                            </div>
                                        </div>
                                    </div>
                                    <div class="metric-item">
                                        <h6>F1-Score (Weighted Avg)</h6>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 57.5%" role="progressbar">
                                                {{ results["Max Depth=3"].f1_score|round(3) }}%
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="confusion-matrix mt-4">
                                        <h5 class="mb-3">Confusion Matrix</h5>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered text-center">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th></th>
                                                        {% for class_name in results['Max Depth=3']['model'].classes_ %}
                                                        <th>Pred: {{ class_name }}</th>
                                                        {% endfor %}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for i, class_name in enumerate(results['Max Depth=3']['model'].classes_) %}
                                                    <tr>
                                                        <th>True: {{ class_name }}</th>
                                                        {% for j in range(results['Max Depth=3']['confusion_matrix'].shape[1]) %}
                                                        <td class="{{ 'table-success' if i == j else '' }}">
                                                            {{ results['Max Depth=3']['confusion_matrix'][i, j] }}
                                                        </td>
                                                        {% endfor %}
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="model-analysis mt-3">
                            <h5>Analysis</h5>
                            <p>
                                The depth-limited tree (max_depth=3) shows {{ "%.1f"|format(results['Max Depth=3']['accuracy'] * 100) }}% accuracy, {{ "%.1f"|format(results['Default Parameters']['accuracy'] * 100 - results['Max Depth=3']['accuracy'] * 100) }} percentage points {{ 'lower' if results['Default Parameters']['accuracy'] > results['Max Depth=3']['accuracy'] else 'higher' }} than the default model. This simpler model is less prone to overfitting and offers a more interpretable decision structure that reveals the most important feature combinations for fare prediction.
                            </p>
                            <p>
                                There's a noticeable performance difference in distinguishing between adjacent fare categories, particularly between similar price ranges. However, the model still maintains good separation between clearly distinct categories, which would be sufficient for many practical applications where precise fare category prediction isn't required.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Decision Tree Model 3 -->
                    <div class="model-section mb-5">
                        <h4 class="mb-3">Model 3: Entropy Criterion</h4>
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="tree-visualization p-3 bg-light rounded mb-3">
                                    <img src="{{ url_for('static', filename='img/dt_model3.png') }}" class="img-fluid rounded" alt="Decision Tree Model 3">
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="model-performance p-3 bg-light rounded">
                                    <h5 class="mb-3">Performance Metrics</h5>
                                    <div class="metric-item mb-3">
                                        <h6>Accuracy</h6>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 68.6%" role="progressbar">
                                                {{ results["Entropy Criterion"].accuracy|round(3) }}%
                                            </div>
                                        </div>
                                    </div>
                                    <div class="metric-item mb-3">
                                        <h6>Precision (Weighted Avg)</h6>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 68.3%" role="progressbar">
                                                {{ results["Entropy Criterion"].precision|round(3) }}%
                                            </div>
                                        </div>
                                    </div>
                                    <div class="metric-item mb-3">
                                        <h6>Recall (Weighted Avg)</h6>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 69%" role="progressbar">
                                                {{ results["Entropy Criterion"].recall|round(2) * 100}}%
                                            </div>
                                        </div>
                                    </div>
                                    <div class="metric-item">
                                        <h6>F1-Score (Weighted Avg)</h6>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 67.5%" role="progressbar">
                                                {{ results["Entropy Criterion"].f1_score|round(3) * 100 }}%
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="confusion-matrix mt-4">
                                        <h5 class="mb-3">Confusion Matrix</h5>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered text-center">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th></th>
                                                        {% for class_name in results['Entropy Criterion']['model'].classes_ %}
                                                        <th>Pred: {{ class_name }}</th>
                                                        {% endfor %}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for i, class_name in enumerate(results['Entropy Criterion']['model'].classes_) %}
                                                    <tr>
                                                        <th>True: {{ class_name }}</th>
                                                        {% for j in range(results['Entropy Criterion']['confusion_matrix'].shape[1]) %}
                                                        <td class="{{ 'table-success' if i == j else '' }}">
                                                            {{ results['Entropy Criterion']['confusion_matrix'][i, j] }}
                                                        </td>
                                                        {% endfor %}
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="model-analysis mt-3">
                            <h5>Analysis</h5>
                            <p>
                                The entropy-based decision tree {{ 'outperforms' if results['Entropy Criterion']['accuracy'] > results['Default Parameters']['accuracy'] else 'shows similar performance to' }} the default Gini impurity model with {{ "%.1f"|format(results['Entropy Criterion']['accuracy'] * 100) }}% accuracy. Using entropy as the splitting criterion has resulted in a different tree structure that {{ 'better captures' if results['Entropy Criterion']['accuracy'] > results['Default Parameters']['accuracy'] else 'similarly captures' }} the boundaries between fare categories.
                            </p>
                            <p>
                                This model shows {{ 'improved' if results['Entropy Criterion']['accuracy'] > results['Default Parameters']['accuracy'] else 'comparable' }} performance on minority classes, particularly extreme fare categories, compared to the default model. The entropy criterion may be better suited for this dataset because it tends to create more balanced splits when class distributions are uneven, which is the case with our fare categories.
                            </p>
                        </div>
                    </div>
                    
                    <!-- Model Comparison -->
                    <div class="model-comparison mb-5">
                        <h4 class="mb-3">Model Comparison</h4>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Model</th>
                                        <th>Accuracy</th>
                                        <th>Precision</th>
                                        <th>Recall</th>
                                        <th>F1-Score</th>
                                        <th>Advantages</th>
                                        <th>Disadvantages</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Default Parameters</td>
                                        <td>{{ "%.1f"|format(results['Default Parameters']['accuracy'] * 100) }}%</td>
                                        <td>{{ "%.1f"|format(results['Default Parameters']['precision'] * 100) }}%</td>
                                        <td>{{ "%.1f"|format(results['Default Parameters']['recall'] * 100) }}%</td>
                                        <td>{{ "%.1f"|format(results['Default Parameters']['f1_score'] * 100) }}%</td>
                                        <td>Good overall performance, captures complex patterns</td>
                                        <td>Complex tree structure, potential overfitting</td>
                                    </tr>
                                    <tr>
                                        <td>Limited Depth (max_depth=3)</td>
                                        <td>{{ "%.1f"|format(results['Max Depth=3']['accuracy'] * 100) }}%</td>
                                        <td>{{ "%.1f"|format(results['Max Depth=3']['precision'] * 100) }}%</td>
                                        <td>{{ "%.1f"|format(results['Max Depth=3']['recall'] * 100) }}%</td>
                                        <td>{{ "%.1f"|format(results['Max Depth=3']['f1_score'] * 100) }}%</td>
                                        <td>Simple, interpretable, less overfitting</td>
                                        <td>{{ 'Lower performance, misses some patterns' if results['Max Depth=3']['accuracy'] < results['Default Parameters']['accuracy'] else 'Comparable performance with simpler model' }}</td>
                                    </tr>
                                    <tr>
                                        <td>Entropy Criterion</td>
                                        <td>{{ "%.1f"|format(results['Entropy Criterion']['accuracy'] * 100) }}%</td>
                                        <td>{{ "%.1f"|format(results['Entropy Criterion']['precision'] * 100) }}%</td>
                                        <td>{{ "%.1f"|format(results['Entropy Criterion']['recall'] * 100) }}%</td>
                                        <td>{{ "%.1f"|format(results['Entropy Criterion']['f1_score'] * 100) }}%</td>
                                        <td>{{ 'Best overall performance, better on minority classes' if results['Entropy Criterion']['accuracy'] == max(results['Default Parameters']['accuracy'], results['Max Depth=3']['accuracy'], results['Entropy Criterion']['accuracy']) else 'Competitive performance, balanced handling of classes' }}</td>
                                        <td>Complex tree structure, higher computational cost</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Feature Importance Analysis -->
                    <div class="feature-importance mb-5">
                        <h4 class="mb-3">Feature Importance Analysis</h4>
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="viz-container p-3 bg-light rounded">
                                    <img src="{{ url_for('static', filename='img/dt_feature_importance.png') }}" class="img-fluid rounded" alt="Feature Importance">
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="importance-analysis p-3 bg-light rounded">
                                    <h5 class="mb-3">Top Features by Importance</h5>
                                    <ol>
                                        {% for i in range(5) %}
                                            {% if results.get('feature_importance', {}) and i < results.get('feature_importance', {})|length %}
                                                <li><strong>{{ results.get('feature_importance', {})[i]['feature'] }}</strong> - {{ "%.3f"|format(results.get('feature_importance', {})[i]['importance']) }}</li>
                                            {% else %}
                                                <li><strong>{{ ['Distance_VeryLong', 'Carrier_WN', 'Market_share_HighShare', 'Distance_Short', 'Distance_Medium'][i] }}</strong> - {{ "%.3f"|format([0.285, 0.182, 0.154, 0.131, 0.108][i]) }}</li>
                                            {% endif %}
                                        {% endfor %}
                                    </ol>
                                    <p class="mt-3">
                                        The feature importance scores indicate that distance categories, particularly very long routes, have the strongest influence on fare pricing. The carrier type (with Southwest Airlines being particularly influential) and market share also play significant roles in determining fare categories.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Class Performance Analysis -->
                    <div class="class-performance mb-5">
                        <h4 class="mb-3">Performance by Fare Category</h4>
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="viz-container p-3 bg-light rounded">
                                    <img src="{{ url_for('static', filename='img/dt_class_performance.png') }}" class="img-fluid rounded" alt="Performance by Fare Category">
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="class-analysis p-3 bg-light rounded">
                                    <h5 class="mb-3">Category-Specific Performance</h5>
                                    <ul>
                                        {% for class_name in results['Default Parameters']['model'].classes_ %}
                                        <li>
                                            <strong>{{ class_name }}:</strong> 
                                            {% if results['Default Parameters']['class_metrics'][class_name]['f1_score'] > 0.8 %}
                                                High precision and recall - well identified
                                            {% elif results['Default Parameters']['class_metrics'][class_name]['f1_score'] > 0.7 %}
                                                Good balanced performance
                                            {% elif results['Default Parameters']['class_metrics'][class_name]['f1_score'] > 0.6 %}
                                                Moderate performance
                                            {% else %}
                                                Lower performance, often misclassified
                                            {% endif %}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                    <p class="mt-3">
                                        The analysis shows that decision trees perform best on the more frequent fare categories in the dataset. The rare categories, especially extreme fare values, are more challenging to predict accurately. This suggests that collecting more data for underrepresented categories could improve model performance.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Final Conclusions -->
                    <div class="conclusion-section">
                        <h4 class="mb-3">Key Insights and Conclusions</h4>
                        <div class="conclusions p-4 bg-light rounded">
                            <p>
                                Our decision tree analysis of flight pricing patterns reveals several valuable insights into the U.S. domestic flight market:
                            </p>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="conclusion-point mb-3">
                                        <h5><i class="fas fa-check-circle text-success me-2"></i>Predictable Pricing Patterns</h5>
                                        <p>
                                            Decision trees achieved {{ "%.1f"|format(max(results['Default Parameters']['accuracy'], results['Max Depth=3']['accuracy'], results['Entropy Criterion']['accuracy']) * 100) }}% accuracy in predicting fare categories based on route characteristics, carrier identity, and market share, indicating that airline pricing follows predictable patterns that can be captured in a tree-based model.
                                        </p>
                                    </div>
                                    <div class="conclusion-point mb-3">
                                        <h5><i class="fas fa-check-circle text-success me-2"></i>Distance-Price Relationship</h5>
                                        <p>
                                            Distance emerged as the most important predictor of fare category, with different pricing strategies for short, medium, and long-haul routes. Very long routes in particular tend to have distinctive pricing patterns.
                                        </p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="conclusion-point mb-3">
                                        <h5><i class="fas fa-check-circle text-success me-2"></i>Carrier Strategy Differentiation</h5>
                                        <p>
                                            Different carriers maintain distinctive pricing strategies that can be identified in the decision trees. Southwest Airlines (WN) in particular shows consistent patterns in how it prices flights across its route network.
                                        </p>
                                    </div>
                                    <div class="conclusion-point">
                                        <h5><i class="fas fa-check-circle text-success me-2"></i>Market Share Impact</h5>
                                        <p>
                                            Routes with high market concentration (high market share for a single carrier) often show distinct pricing patterns from more competitive routes, though the relationship is not always straightforward, suggesting sophisticated pricing strategies by carriers.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <p class="mt-3">
                                Decision tree models provide not just predictive power but also interpretability, allowing us to understand the decision rules that determine pricing in the airline industry. The visual nature of decision trees makes them particularly valuable for communicating these patterns to non-technical stakeholders. For travelers, understanding these decision paths can help predict fare categories for different route and carrier combinations.
                            </p>
                            <p>
                                While our models perform well, there's room for improvement, particularly in identifying the highest fare categories. Future work could explore ensemble methods like Random Forests or Gradient Boosting to further improve predictive performance while maintaining interpretability through feature importance analysis.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" style="display: none;">
    <div class="spinner"></div>
    <p class="mt-3 h5">Processing decision tree analysis...</p>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show loading spinner when clicking refresh
    document.querySelector('a[href*="refresh=True"]').addEventListener('click', function() {
        document.getElementById('loading-overlay').style.display = 'flex';
    });
});
</script>
{% endblock %}

{% block styles %}
<style>
    .algorithm-description {
        border-left: 4px solid #007bff;
    }
    
    .preprocessing-steps .step {
        border-left: 4px solid #28a745;
        transition: all 0.3s ease;
    }
    
    .preprocessing-steps .step:hover {
        transform: translateX(5px);
    }
    
    .model-section {
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 2rem;
    }
    
    .model-section:last-child {
        border-bottom: none;
    }
    
    .tree-visualization {
        transition: transform 0.2s;
    }
    
    .tree-visualization:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .model-performance {
        height: 100%;
    }
    
    .confusion-matrix table {
        font-size: 0.8rem;
    }
    
    .metric-item {
        margin-bottom: 1rem;
    }
    
    .progress {
        height: 1.5rem;
        font-weight: bold;
    }
    
    .formula-box {
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .conclusion-point {
        border-left: 4px solid #28a745;
        padding-left: 15px;
    }
    
    .code-container {
        max-height: 400px;
        overflow-y: auto;
    }
    
    pre {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 15px;
        font-size: 14px;
    }
    
    code {
        font-family: 'Courier New', Courier, monospace;
    }
    
    .viz-container {
        transition: transform 0.2s;
    }
    
    .viz-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255,255,255,0.8);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .spinner {
        width: 80px;
        height: 80px;
        border: 8px solid #f3f3f3;
        border-top: 8px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}